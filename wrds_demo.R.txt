library(RPostgres)

# Create a connection called "wrds"
wrds <- dbConnect(Postgres(),
                  host='wrds-pgdata.wharton.upenn.edu',
                  port=9737,
                  dbname='wrds',
                  sslmode='require',
                  user='hoffa')
# AT THIS POINT, EXPECT A DUO PUSH

download_year <- function(year, outdir) {
  # Define a SELECT query
  query = "select cusip, permco, permno, date, prc, ret, numtrd, vol "
  query = paste(query, "from crsp.dsf ", sep="")
  query = paste(query, "where date >= '", year, "-01-01' and ", sep="")
  query = paste(query, "date <= '", year, "-12-31'", sep="")
  # query

  # Execute the select query
  res <- dbSendQuery(wrds, query)
  data <- dbFetch(res)

  outfile = paste("dsf",year,Sys.Date(),sep="_")
  outpath = paste(outdir, "/", sep="") 
  outpath = paste(outpath, outfile, ".csv", sep="")

  write.csv(data, outpath, row.names=TRUE)
}

download_year(2002, "~/testing")

# Clean up workspace
dbClearResult(res)
